<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6203, Фокин Евгений Андреевич - Лабораторная работа №5</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #121212;
        color: #e0e0e0;
      }
      canvas {
        background-color: #1e1e1e;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        margin-bottom: 20px;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
        justify-content: center;
      }
      .control-group {
        background-color: #1e1e1e;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      }
      h1,
      h3 {
        margin: 0 0 10px;
        color: #e0e0e0;
      }
      button {
        padding: 5px 10px;
        margin: 0 5px;
        cursor: pointer;
        background-color: #333;
        color: #e0e0e0;
        border: none;
        border-radius: 3px;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: #444;
      }
      input[type="range"] {
        width: 150px;
        accent-color: #bb86fc;
      }
    </style>
  </head>
  <body>
    <h1>Лабораторная работа №5<br />Группа 6203, Фокин Евгений Андреевич</h1>
    <div class="controls">
      <div class="control-group">
        <h3>Вращение</h3>
        <div>
          X: <input type="range" id="rotateX" min="0" max="360" value="0" />
        </div>
        <div>
          Y: <input type="range" id="rotateY" min="0" max="360" value="0" />
        </div>
        <div>
          Z: <input type="range" id="rotateZ" min="0" max="360" value="0" />
        </div>
        <button id="resetRotation">Сбросить вращение</button>
      </div>
      <div class="control-group">
        <h3>Положение</h3>
        <div>
          X:
          <input type="range" id="positionX" min="-200" max="200" value="0" />
        </div>
        <div>
          Y:
          <input type="range" id="positionY" min="-200" max="200" value="0" />
        </div>
        <div>
          Z:
          <input type="range" id="positionZ" min="-500" max="100" value="0" />
        </div>
        <button id="resetPosition">Сбросить положение</button>
      </div>
      <div class="control-group">
        <h3>Масштаб и параметры</h3>
        <div>
          Масштаб:
          <input type="range" id="scale" min="10" max="200" value="100" />
        </div>
        <div>
          R: <input type="range" id="paramR" min="50" max="200" value="100" />
        </div>
        <div>
          r: <input type="range" id="paramr" min="10" max="100" value="40" />
        </div>
        <button id="resetScale">Сбросить масштаб</button>
      </div>
    </div>
    <canvas id="canvas" width="800" height="600"></canvas>
    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      let R = 100,
        r = 40,
        scale = 1;
      let rotationX = 0,
        rotationY = 0,
        rotationZ = 0;
      let positionX = 0,
        positionY = 0,
        positionZ = 0;

      const projectionMatrix = [
        [1, 0, 0, 0],
        [0, 1, 0, 0],
        [0, 0, 0, 0],
        [0, 0, 0, 1],
      ];

      function bindControls() {
        const rotateXSlider = document.getElementById("rotateX");
        const rotateYSlider = document.getElementById("rotateY");
        const rotateZSlider = document.getElementById("rotateZ");
        const positionXSlider = document.getElementById("positionX");
        const positionYSlider = document.getElementById("positionY");
        const positionZSlider = document.getElementById("positionZ");
        const scaleSlider = document.getElementById("scale");
        const paramRSlider = document.getElementById("paramR");
        const paramrSlider = document.getElementById("paramr");

        // Обработчики событий
        rotateXSlider.addEventListener("input", (e) => {
          rotationX = +e.target.value;
          drawTorus();
        });
        rotateYSlider.addEventListener("input", (e) => {
          rotationY = +e.target.value;
          drawTorus();
        });
        rotateZSlider.addEventListener("input", (e) => {
          rotationZ = +e.target.value;
          drawTorus();
        });

        positionXSlider.addEventListener("input", (e) => {
          positionX = +e.target.value;
          drawTorus();
        });
        positionYSlider.addEventListener("input", (e) => {
          positionY = +e.target.value;
          drawTorus();
        });
        positionZSlider.addEventListener("input", (e) => {
          positionZ = +e.target.value;
          drawTorus();
        });

        scaleSlider.addEventListener("input", (e) => {
          scale = +e.target.value / 100;
          drawTorus();
        });
        paramRSlider.addEventListener("input", (e) => {
          R = +e.target.value;
          drawTorus();
        });
        paramrSlider.addEventListener("input", (e) => {
          r = +e.target.value;
          drawTorus();
        });

        document
          .getElementById("resetRotation")
          .addEventListener("click", () => {
            rotationX = rotationY = rotationZ = 0;
            rotateXSlider.value = rotateYSlider.value = rotateZSlider.value = 0;
            drawTorus();
          });
        document
          .getElementById("resetPosition")
          .addEventListener("click", () => {
            positionX = positionY = positionZ = 0;
            positionXSlider.value =
              positionYSlider.value =
              positionZSlider.value =
                0;
            drawTorus();
          });
        document.getElementById("resetScale").addEventListener("click", () => {
          scale = 1;
          R = 100;
          r = 40;
          scaleSlider.value = 100;
          paramRSlider.value = 100;
          paramrSlider.value = 40;
          drawTorus();
        });
      }

      bindControls();

      function multiplyMatrix(a, b) {
        const result = [];
        for (let i = 0; i < 4; i++) {
          result[i] = [];
          for (let j = 0; j < 4; j++) {
            let sum = 0;
            for (let k = 0; k < 4; k++) sum += a[i][k] * b[k][j];
            result[i][j] = sum;
          }
        }
        return result;
      }

      function multiplyVec(m, v) {
        return m.map((row) => row.reduce((s, val, idx) => s + val * v[idx], 0));
      }

      function getRotationX(angle) {
        const rad = (angle * Math.PI) / 180;
        return [
          [1, 0, 0, 0],
          [0, Math.cos(rad), -Math.sin(rad), 0],
          [0, Math.sin(rad), Math.cos(rad), 0],
          [0, 0, 0, 1],
        ];
      }

      function getRotationY(angle) {
        const rad = (angle * Math.PI) / 180;
        return [
          [Math.cos(rad), 0, Math.sin(rad), 0],
          [0, 1, 0, 0],
          [-Math.sin(rad), 0, Math.cos(rad), 0],
          [0, 0, 0, 1],
        ];
      }

      function getRotationZ(angle) {
        const rad = (angle * Math.PI) / 180;
        return [
          [Math.cos(rad), -Math.sin(rad), 0, 0],
          [Math.sin(rad), Math.cos(rad), 0, 0],
          [0, 0, 1, 0],
          [0, 0, 0, 1],
        ];
      }

      function getTranslation(x, y, z) {
        return [
          [1, 0, 0, x],
          [0, 1, 0, y],
          [0, 0, 1, z],
          [0, 0, 0, 1],
        ];
      }

      function getScale(s) {
        return [
          [s, 0, 0, 0],
          [0, s, 0, 0],
          [0, 0, s, 0],
          [0, 0, 0, 1],
        ];
      }

      function createTorus(alphaSteps = 20, betaSteps = 30) {
        const pts = [];
        for (let i = 0; i <= alphaSteps; i++) {
          const a = (i / alphaSteps) * 2 * Math.PI;
          const row = [];
          for (let j = 0; j <= betaSteps; j++) {
            const b = (j / betaSteps) * 2 * Math.PI;
            row.push([
              (R + r * Math.cos(a)) * Math.cos(b),
              (R + r * Math.cos(a)) * Math.sin(b),
              r * Math.sin(a),
              1,
            ]);
          }
          pts.push(row);
        }
        return pts;
      }

      function drawTorus() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#1e1e1e";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        const torus = createTorus();

        let M = getScale(scale);

        M = multiplyMatrix(M, getRotationX(rotationX));
        M = multiplyMatrix(M, getRotationY(rotationY));
        M = multiplyMatrix(M, getRotationZ(rotationZ));
        M = multiplyMatrix(M, getTranslation(positionX, positionY, positionZ));

        const projected = torus.map((row) =>
          row.map((pt) => {
            const t = multiplyVec(M, pt);
            const p = multiplyVec(projectionMatrix, [t[0], t[1], t[2], 1]);
            return {
              x: p[0] + canvas.width / 2,
              y: p[1] + canvas.height / 2,
              depth: t[2],
            };
          })
        );

        ctx.strokeStyle = "#bb86fc";
        ctx.lineWidth = 1;
        projected.forEach((row) => {
          ctx.beginPath();
          row.forEach((p, i) =>
            i ? ctx.lineTo(p.x, p.y) : ctx.moveTo(p.x, p.y)
          );
          ctx.stroke();
        });
        for (let j = 0; j < projected[0].length; j++) {
          ctx.beginPath();
          projected.forEach((row, i) =>
            i ? ctx.lineTo(row[j].x, row[j].y) : ctx.moveTo(row[j].x, row[j].y)
          );
          ctx.stroke();
        }
      }

      drawTorus();
    </script>
  </body>
</html>
