<style>
  canvas {
    width: 400px;
  }
</style>

<canvas id="original"></canvas>

<script>
  function applySobel(canvas, A, B, M, N = 1) {
    const resultCanvas = document.createElement("canvas");
    resultCanvas.width = canvas.width;
    resultCanvas.height = canvas.height;
    const resultCtx = resultCanvas.getContext("2d");

    const ctx = canvas.getContext("2d");
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    const outputData = new Uint8ClampedArray(data.length);

    const size = 2 * N + 1;

    const grayscale = new Array(canvas.width * canvas.height);
    for (let i = 0; i < data.length; i += 4) {
      grayscale[i / 4] =
        0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
    }

    for (let y = N; y < canvas.height - N; y++) {
      for (let x = N; x < canvas.width - N; x++) {
        let sum = 0;

        // C(X+i, Y+j) * M(i, j)
        for (let i = -N; i <= N; i++) {
          for (let j = -N; j <= N; j++) {
            const pixelX = x + j;
            const pixelY = y + i;
            const idx = pixelY * canvas.width + pixelX;

            const matrixValue = M[i + N][j + N];
            sum += grayscale[idx] * matrixValue;
          }
        }

        let newValue = A + B * sum;
        newValue = Math.max(0, Math.min(255, newValue));

        const pos = (y * canvas.width + x) * 4;
        outputData[pos] = outputData[pos + 1] = outputData[pos + 2] = newValue;
        outputData[pos + 3] = 255;
      }
    }

    resultCtx.putImageData(
      new ImageData(outputData, canvas.width, canvas.height),
      0,
      0
    );
    return resultCanvas;
  }

  const canvas = document.getElementById("original");

  const A = 0;
  const B = 1 / 4;
  const M = [
    [-1, 0, 1],
    [-2, 0, 2],
    [-1, 0, 1],
  ];
  const N = 1;

  const img = new Image();
  img.src = "./test2.png";

  img.addEventListener("load", () => {
    drawImageToCanvas(img);
  });

  function drawImageToCanvas(img) {
    canvas.width = img.width;
    canvas.height = img.height;

    canvas.getContext("2d").drawImage(img, 0, 0);
    const resultCanvas = applySobel(canvas, A, B, M, N);
    document.body.appendChild(resultCanvas);
  }
</script>
